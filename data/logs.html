<!doctype html>
<html>
  <head>
    <title>LinkLight - Logs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.19.1/cdn/themes/dark.css"
    />
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.19.1/cdn/shoelace-autoloader.js"
    ></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      body {
        background-color: #1e1e1e;
        color: #d4d4d4;
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
        font-family: var(--sl-font-sans);
      }

      h1 {
        color: #4ec9b0;
        margin: 0 0 10px 0;
        flex-shrink: 0;
      }

      .controls {
        margin: 20px 0;
        padding: 15px;
        background-color: #252526;
        border-radius: var(--sl-border-radius-medium);
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      sl-select {
        min-width: 150px;
      }

      .log-container {
        background-color: #1e1e1e;
        border: 1px solid #3c3c3c;
        border-radius: var(--sl-border-radius-medium);
        padding: 15px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        font-family: var(--sl-font-mono);
      }

      .log-entry {
        margin: 4px 0;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre;
      }

      .log-entry:hover {
        background-color: #2d2d30;
      }

      .log-timestamp {
        color: #858585;
        font-size: 11px;
        margin-right: 10px;
      }

      .log-tag {
        font-weight: bold;
        margin-right: 10px;
      }

      .log-level-I {
        color: #4ec9b0;
      }

      .log-level-W {
        color: #dcdcaa;
      }

      .log-level-E {
        color: #f48771;
      }

      .log-level-D {
        color: #9cdcfe;
      }

      .log-level-V {
        color: #c586c0;
      }
    </style>
  </head>
  <body class="sl-theme-dark">
    <h1>LinkLight - System logs</h1>

    <div class="controls">
      <sl-button href="/" size="small">Home</sl-button>

      <sl-select
        id="levelFilter"
        size="small"
        value="all"
        aria-label="Filter logs by level"
      >
        <sl-option value="all">All</sl-option>
        <sl-option value="E">Error</sl-option>
        <sl-option value="W">Warning</sl-option>
        <sl-option value="I">Info</sl-option>
        <sl-option value="D">Debug</sl-option>
        <sl-option value="V">Verbose</sl-option>
      </sl-select>

      <sl-button id="pauseButton" size="small">Pause</sl-button>
      <sl-button id="clearButton" size="small">Clear display</sl-button>

      <sl-badge id="connectionStatus" variant="neutral" pill
        >Connecting...</sl-badge
      >
    </div>

    <sl-alert
      id="status"
      variant="danger"
      style="flex-shrink: 0; margin: 0 0 10px 0"
    ></sl-alert>

    <div class="log-container" id="logContainer">
      <div style="color: #858585; text-align: center; padding: 20px">
        Connecting to log stream...
      </div>
    </div>

    <script>
      let allLogs = [];
      let isPaused = false;
      let ws = null;
      let reconnectTimer = null;
      let wsPort = 81; // WebSocket port

      const pauseButton = document.getElementById("pauseButton");
      const clearButton = document.getElementById("clearButton");
      const levelFilter = document.getElementById("levelFilter");
      const statusAlert = document.getElementById("status");

      levelFilter.addEventListener("sl-change", filterLogs);
      pauseButton.addEventListener("click", togglePause);
      clearButton.addEventListener("click", clearDisplay);

      function formatTimestamp(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);

        const s = seconds % 60;
        const m = minutes % 60;
        const h = hours % 24;

        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
      }

      function getLevelClass(level) {
        return `log-level-${level}`;
      }

      function displayLogs() {
        const container = document.getElementById("logContainer");
        const filter = levelFilter.value;

        let filteredLogs = allLogs;
        if (filter !== "all") {
          filteredLogs = allLogs.filter((log) => log.level === filter);
        }

        if (filteredLogs.length === 0) {
          container.innerHTML =
            '<div style="color: #858585; text-align: center; padding: 20px;">No logs to display</div>';
          return;
        }

        let html = "";
        filteredLogs.forEach((log) => {
          html += '<div class="log-entry">';
          html += `<span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>`;
          html += `<span class="log-tag ${getLevelClass(log.level)}">[${log.level}] ${log.tag}:</span>`;
          html += `<span class="log-message">${escapeHtml(log.message)}</span>`;
          html += "</div>";
        });

        container.innerHTML = html;

        // Only auto-scroll if not paused
        if (!isPaused) {
          container.scrollTop = container.scrollHeight;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function filterLogs() {
        displayLogs();
      }

      function clearDisplay() {
        allLogs = [];
        displayLogs();
      }

      function togglePause() {
        isPaused = !isPaused;

        if (isPaused) {
          pauseButton.textContent = "Resume";
        } else {
          pauseButton.textContent = "Pause";
          // Refresh display when resuming
          displayLogs();
        }
      }

      function updateStatus(type, message) {
        statusAlert.variant = type === "error" ? "danger" : "success";
        statusAlert.textContent = message;
        statusAlert.open = true;

        // Hide success messages after 3 seconds
        if (type === "success") {
          setTimeout(() => {
            statusAlert.open = false;
          }, 3000);
        }
      }

      function updateConnectionStatus(connected) {
        const badge = document.getElementById("connectionStatus");
        if (connected) {
          badge.textContent = "Connected";
          badge.variant = "success";
        } else {
          badge.textContent = "Disconnected";
          badge.variant = "danger";
        }
      }

      function connectWebSocket() {
        // Get the current hostname and port
        const host = window.location.hostname;

        ws = new WebSocket(`ws://${host}:${wsPort}`);

        ws.onopen = function () {
          console.log("WebSocket connected");
          updateConnectionStatus(true);

          // Clear reconnect timer
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };

        ws.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            if (data.type === "initial") {
              // Initial log batch
              allLogs = data.logs || [];
              displayLogs();
            } else if (data.type === "log") {
              // New single log entry
              const logEntry = {
                timestamp: data.timestamp,
                level: data.level,
                tag: data.tag,
                message: data.message,
              };
              allLogs.push(logEntry);

              // Only update display if not paused
              if (!isPaused) {
                displayLogs();
              }
            }
          } catch (e) {
            console.error("Error parsing WebSocket message:", e);
          }
        };

        ws.onerror = function (error) {
          console.error("WebSocket error:", error);
          updateStatus("error", "WebSocket connection error");
        };

        ws.onclose = function () {
          console.log("WebSocket disconnected");
          updateConnectionStatus(false);
          updateStatus(
            "error",
            "Disconnected from log stream. Reconnecting...",
          );

          // Attempt to reconnect after 3 seconds
          reconnectTimer = setTimeout(() => {
            connectWebSocket();
          }, 3000);
        };
      }

      // Connect on page load
      connectWebSocket();
    </script>
  </body>
</html>
