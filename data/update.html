<!doctype html>
<html>
  <head>
    <title>LinkLight - Firmware update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.19.1/cdn/themes/dark.css"
    />
    <script
      type="module"
      src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.19.1/cdn/shoelace-autoloader.js"
    ></script>
    <style>
      body {
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        box-sizing: border-box;
        font-family: var(--sl-font-sans);
        max-width: 600px;
      }

      h1 {
        color: #4ec9b0;
        margin: 0 0 20px 0;
      }

      .controls {
        margin-bottom: 20px;
      }

      .form-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #252526;
        border-radius: var(--sl-border-radius-medium);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .section-heading {
        color: #9cdcfe;
        font-size: var(--sl-font-size-medium);
        font-weight: var(--sl-font-weight-semibold);
        margin: 0;
      }

      .section-description {
        font-size: var(--sl-font-size-small);
        color: #858585;
        margin: 0;
      }

      input[type="file"] {
        color: #d4d4d4;
        font-family: var(--sl-font-sans);
        font-size: var(--sl-font-size-medium);
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background-color: #3c3c3c;
        border-radius: 4px;
        overflow: hidden;
        display: none;
      }

      .progress-bar-fill {
        height: 100%;
        background-color: #4ec9b0;
        border-radius: 4px;
        transition: width 0.2s;
        width: 0%;
      }
    </style>
  </head>
  <body class="sl-theme-dark">
    <h1>LinkLight - Firmware update</h1>

    <div class="controls">
      <sl-button href="/" size="small">Home</sl-button>
    </div>

    <div class="form-section">
      <p class="section-heading">Firmware</p>
      <p class="section-description">
        Upload a firmware.bin file to update the device firmware.
      </p>
      <input type="file" id="firmwareFile" accept=".bin" />
      <div class="progress-bar" id="firmwareProgress">
        <div class="progress-bar-fill" id="firmwareProgressFill"></div>
      </div>
      <div>
        <sl-button id="firmwareUploadBtn" onclick="uploadFile('firmware')"
          >Upload firmware</sl-button
        >
      </div>
      <sl-alert id="firmwareFeedback" closable></sl-alert>
    </div>

    <div class="form-section">
      <p class="section-heading">Filesystem</p>
      <p class="section-description">
        Upload a littlefs.bin file to update the device filesystem.
      </p>
      <input type="file" id="filesystemFile" accept=".bin" />
      <div class="progress-bar" id="filesystemProgress">
        <div class="progress-bar-fill" id="filesystemProgressFill"></div>
      </div>
      <div>
        <sl-button id="filesystemUploadBtn" onclick="uploadFile('filesystem')"
          >Upload filesystem</sl-button
        >
      </div>
      <sl-alert id="filesystemFeedback" closable></sl-alert>
    </div>

    <script>
      function uploadFile(type) {
        var fileInput = document.getElementById(type + "File");
        var progressBar = document.getElementById(type + "Progress");
        var progressFill = document.getElementById(type + "ProgressFill");
        var feedback = document.getElementById(type + "Feedback");
        var uploadBtn = document.getElementById(type + "UploadBtn");

        if (!fileInput.files || !fileInput.files[0]) {
          feedback.variant = "danger";
          feedback.textContent = "Please select a file first";
          feedback.open = true;
          return;
        }

        var file = fileInput.files[0];
        var formData = new FormData();
        formData.append(type, file);

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/update/" + type, true);

        uploadBtn.disabled = true;
        progressBar.style.display = "block";
        progressFill.style.width = "0%";
        feedback.open = false;

        xhr.upload.onprogress = function (e) {
          if (e.lengthComputable) {
            progressFill.style.width = (e.loaded / e.total) * 100 + "%";
          }
        };

        xhr.onload = function () {
          progressBar.style.display = "none";
          uploadBtn.disabled = false;

          if (xhr.status === 200) {
            feedback.variant = "success";
            feedback.textContent =
              "Upload successful. Device is restarting. This page will reload in 10 seconds.";
            feedback.open = true;
            setTimeout(function () {
              window.location.reload();
            }, 10000);
          } else {
            feedback.variant = "danger";
            feedback.textContent = "Upload failed: " + xhr.responseText;
            feedback.open = true;
          }
        };

        xhr.onerror = function () {
          progressBar.style.display = "none";
          uploadBtn.disabled = false;
          feedback.variant = "danger";
          feedback.textContent = "Network error occurred";
          feedback.open = true;
        };

        xhr.send(formData);
      }
    </script>
  </body>
</html>
