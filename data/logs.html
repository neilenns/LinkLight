<!doctype html>
<html>
  <head>
    <title>LinkLight - Logs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: "Courier New", monospace;
        margin: 0;
        padding: 20px;
        background-color: #1e1e1e;
        color: #d4d4d4;
      }
      h1 {
        color: #4ec9b0;
        font-family: Arial, sans-serif;
        margin-bottom: 10px;
      }
      .controls {
        margin: 20px 0;
        padding: 15px;
        background-color: #252526;
        border-radius: 4px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }
      .controls label {
        font-family: Arial, sans-serif;
        margin-right: 5px;
      }
      .controls select,
      .controls button {
        padding: 8px 12px;
        background-color: #3c3c3c;
        color: #d4d4d4;
        border: 1px solid #555;
        border-radius: 4px;
        cursor: pointer;
        font-family: Arial, sans-serif;
      }
      .controls button:hover {
        background-color: #505050;
      }
      .controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .controls select:focus,
      .controls button:focus {
        outline: 2px solid #0066cc;
      }
      a.home-link {
        display: inline-block;
        padding: 8px 16px;
        background-color: #0066cc;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-family: Arial, sans-serif;
      }
      a.home-link:hover {
        background-color: #0052a3;
      }
      .log-container {
        background-color: #1e1e1e;
        border: 1px solid #3c3c3c;
        border-radius: 4px;
        padding: 15px;
        max-height: 70vh;
        overflow-y: auto;
      }
      .log-entry {
        margin: 4px 0;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 13px;
        line-height: 1.4;
      }
      .log-entry:hover {
        background-color: #2d2d30;
      }
      .log-timestamp {
        color: #858585;
        font-size: 11px;
        margin-right: 10px;
      }
      .log-tag {
        font-weight: bold;
        margin-right: 10px;
      }
      .log-level-I {
        color: #4ec9b0;
      }
      .log-level-W {
        color: #dcdcaa;
      }
      .log-level-E {
        color: #f48771;
      }
      .log-level-D {
        color: #9cdcfe;
      }
      .log-level-V {
        color: #c586c0;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        background-color: #252526;
        border-radius: 4px;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }
      .status.error {
        background-color: #5a1d1d;
        color: #f48771;
      }
      .status.success {
        background-color: #1d5a1d;
        color: #4ec9b0;
      }
      .connection-status {
        color: #858585;
        font-size: 12px;
      }
      .connection-status.connected {
        color: #4ec9b0;
      }
      .connection-status.disconnected {
        color: #f48771;
      }
      .paused-indicator {
        background-color: #5a4d1d;
        color: #dcdcaa;
        padding: 10px;
        border-radius: 4px;
        text-align: center;
        margin: 10px 0;
        display: none;
      }
      .paused-indicator.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>LinkLight - System Logs</h1>

    <div class="controls">
      <a href="/" class="home-link">Home</a>

      <label for="levelFilter">Filter Level:</label>
      <select
        id="levelFilter"
        aria-label="Filter logs by level"
        onchange="filterLogs()"
      >
        <option value="all">All</option>
        <option value="E">Error</option>
        <option value="W">Warning</option>
        <option value="I">Info</option>
        <option value="D">Debug</option>
        <option value="V">Verbose</option>
      </select>

      <button id="pauseButton" onclick="togglePause()">Pause</button>
      <button onclick="clearDisplay()">Clear Display</button>

      <span class="connection-status" id="connectionStatus">Connecting...</span>
    </div>

    <div id="pausedIndicator" class="paused-indicator">
      ⏸ Display Paused - New logs are being buffered
    </div>

    <div id="status" class="status" style="display: none"></div>

    <div class="log-container" id="logContainer">
      <div style="color: #858585; text-align: center; padding: 20px">
        Connecting to log stream...
      </div>
    </div>

    <script>
      let allLogs = [];
      let isPaused = false;
      let ws = null;
      let reconnectTimer = null;
      let wsPort = 81; // WebSocket port

      function formatTimestamp(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);

        const s = seconds % 60;
        const m = minutes % 60;
        const h = hours % 24;

        return (
          String(h).padStart(2, "0") +
          ":" +
          String(m).padStart(2, "0") +
          ":" +
          String(s).padStart(2, "0")
        );
      }

      function getLevelClass(level) {
        return "log-level-" + level;
      }

      function displayLogs() {
        const container = document.getElementById("logContainer");
        const filter = document.getElementById("levelFilter").value;

        let filteredLogs = allLogs;
        if (filter !== "all") {
          filteredLogs = allLogs.filter((log) => log.level === filter);
        }

        if (filteredLogs.length === 0) {
          container.innerHTML =
            '<div style="color: #858585; text-align: center; padding: 20px;">No logs to display</div>';
          return;
        }

        let html = "";
        filteredLogs.forEach((log) => {
          html += '<div class="log-entry">';
          html +=
            '<span class="log-timestamp">' +
            formatTimestamp(log.timestamp) +
            "</span>";
          html +=
            '<span class="log-tag ' +
            getLevelClass(log.level) +
            '">[' +
            log.level +
            "] " +
            log.tag +
            ":</span>";
          html +=
            '<span class="log-message">' + escapeHtml(log.message) + "</span>";
          html += "</div>";
        });

        container.innerHTML = html;
        
        // Only auto-scroll if not paused
        if (!isPaused) {
          container.scrollTop = container.scrollHeight;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function filterLogs() {
        displayLogs();
      }

      function clearDisplay() {
        allLogs = [];
        displayLogs();
      }

      function togglePause() {
        isPaused = !isPaused;
        const button = document.getElementById("pauseButton");
        const indicator = document.getElementById("pausedIndicator");
        
        if (isPaused) {
          button.textContent = "Resume";
          indicator.classList.add("visible");
        } else {
          button.textContent = "Pause";
          indicator.classList.remove("visible");
          // Refresh display when resuming
          displayLogs();
        }
      }

      function updateStatus(type, message) {
        const statusDiv = document.getElementById("status");
        statusDiv.textContent = message;
        statusDiv.className = "status " + (type === "error" ? "error" : type === "success" ? "success" : "");
        statusDiv.style.display = "block";

        // Hide success messages after 3 seconds
        if (type === "success") {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 3000);
        }
      }

      function updateConnectionStatus(connected) {
        const statusSpan = document.getElementById("connectionStatus");
        if (connected) {
          statusSpan.textContent = "● Connected";
          statusSpan.className = "connection-status connected";
        } else {
          statusSpan.textContent = "● Disconnected";
          statusSpan.className = "connection-status disconnected";
        }
      }

      function connectWebSocket() {
        // Get the current hostname and port
        const host = window.location.hostname;
        
        ws = new WebSocket("ws://" + host + ":" + wsPort);

        ws.onopen = function() {
          console.log("WebSocket connected");
          updateConnectionStatus(true);
          updateStatus("success", "Connected to log stream");
          
          // Clear reconnect timer
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };

        ws.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            
            if (data.type === "initial") {
              // Initial log batch
              allLogs = data.logs || [];
              displayLogs();
            } else if (data.type === "log") {
              // New single log entry
              const logEntry = {
                timestamp: data.timestamp,
                level: data.level,
                tag: data.tag,
                message: data.message
              };
              allLogs.push(logEntry);
              
              // Only update display if not paused
              if (!isPaused) {
                displayLogs();
              }
            }
          } catch (e) {
            console.error("Error parsing WebSocket message:", e);
          }
        };

        ws.onerror = function(error) {
          console.error("WebSocket error:", error);
          updateStatus("error", "WebSocket connection error");
        };

        ws.onclose = function() {
          console.log("WebSocket disconnected");
          updateConnectionStatus(false);
          updateStatus("error", "Disconnected from log stream. Reconnecting...");
          
          // Attempt to reconnect after 3 seconds
          reconnectTimer = setTimeout(() => {
            connectWebSocket();
          }, 3000);
        };
      }

      // Connect on page load
      connectWebSocket();
    </script>
  </body>
</html>
