<!doctype html>
<html class="wa-dark wa-cloak" lang="en">
  <head>
    <title>LinkLight - Logs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script
      src="https://kit.webawesome.com/2ef289f478d44f55.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
    <link rel="stylesheet" href="global.css" />
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="/notyf.js" defer></script>
    <style>
      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      body {
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
      }

      .controls {
        display: flex;
        gap: 10px;
        padding-bottom: 10px;
        align-items: center;
        flex-wrap: wrap;
        flex-shrink: 0;
      }

      .log-container {
        background-color: var(--wa-color-surface-raised);
        border: var(--wa-border-style) var(--wa-border-width-s)
          var(--wa-color-surface-border);
        border-radius: var(--wa-border-radius-m);
        padding: 15px;
        flex: 1;
        overflow-y: auto;
        min-height: 0;
        font-family: var(--wa-font-family-code);
      }

      .log-entry {
        margin: 4px 0;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre;
      }

      .log-container-message {
        text-align: center;
        color: var(--wa-color-neutral-on-quiet);
      }

      .log-entry:hover {
        background-color: color-mix(
          in oklab,
          var(--wa-color-brand-fill-normal) 100%,
          var(--wa-color-mix-hover)
        );
      }

      .log-timestamp {
        color: var(--wa-color-neutral-on-quiet);
        font-size: 11px;
        margin-right: 10px;
      }

      .log-tag {
        font-weight: bold;
        margin-right: 10px;
      }

      .log-level-I .log-tag {
        color: var(--wa-color-brand-on-normal);
      }

      .log-level-W .log-tag {
        color: var(--wa-color-warning-on-normal);
      }

      .log-level-E .log-tag {
        color: var(--wa-color-danger-on-normal);
      }

      .log-level-D .log-tag {
        color: var(--wa-color-cyan-20);
      }

      .log-level-V .log-tag {
        color: var(--wa-color-purple-20);
      }

      .log-level-D .log-message {
        color: var(--wa-color-neutral-on-quiet);
      }

      .log-level-V .log-message {
        color: var(--wa-color-neutral-on-quiet);
      }
    </style>
  </head>
  <body>
    <h1>LinkLight - System logs</h1>

    <div class="controls">
      <wa-select
        id="levelFilter"
        size="small"
        value="all"
        aria-label="Filter logs by level"
      >
        <wa-option value="all">All</wa-option>
        <wa-option value="E">Error</wa-option>
        <wa-option value="W">Warning</wa-option>
        <wa-option value="I">Info</wa-option>
        <wa-option value="D">Debug</wa-option>
        <wa-option value="V">Verbose</wa-option>
      </wa-select>

      <wa-button id="pauseButton" size="small">Pause</wa-button>
      <wa-button id="clearButton" size="small">Clear display</wa-button>
      <wa-badge id="connectionStatus" variant="danger" pill
        >Disconnected</wa-badge
      >
    </div>

    <div class="log-container" id="logContainer">
      <div class="log-container-message">Connecting to log stream...</div>
    </div>

    <script>
      let allLogs = [];
      let isPaused = false;
      let ws = null;
      let reconnectTimer = null;
      let wsPort = 81; // WebSocket port

      const pauseButton = document.getElementById("pauseButton");
      const clearButton = document.getElementById("clearButton");
      const levelFilter = document.getElementById("levelFilter");

      levelFilter.addEventListener("change", filterLogs);
      pauseButton.addEventListener("click", togglePause);
      clearButton.addEventListener("click", clearDisplay);

      function formatTimestamp(ms) {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);

        const s = seconds % 60;
        const m = minutes % 60;
        const h = hours % 24;

        return `${String(h).padStart(2, "0")}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
      }

      function getLevelClass(level) {
        return `log-level-${level}`;
      }

      function displayLogs() {
        const container = document.getElementById("logContainer");
        const filter = levelFilter.value;

        let filteredLogs = allLogs;
        if (filter !== "all") {
          filteredLogs = allLogs.filter((log) => log.level === filter);
        }

        if (filteredLogs.length === 0) {
          container.innerHTML =
            '<div class="log-container-message">No logs to display</div>';
          return;
        }

        let html = "";
        filteredLogs.forEach((log) => {
          html += `<div class="log-entry ${getLevelClass(log.level)}">`;
          html += `<span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>`;
          html += `<span class="log-tag">[${log.level}] ${log.tag}:</span>`;
          html += `<span class="log-message">${escapeHtml(log.message)}</span>`;
          html += "</div>";
        });

        container.innerHTML = html;

        // Only auto-scroll if not paused
        if (!isPaused) {
          container.scrollTop = container.scrollHeight;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function filterLogs() {
        displayLogs();
      }

      function clearDisplay() {
        allLogs = [];
        displayLogs();
      }

      function togglePause() {
        isPaused = !isPaused;

        if (isPaused) {
          pauseButton.textContent = "Resume";
        } else {
          pauseButton.textContent = "Pause";
          // Refresh display when resuming
          displayLogs();
        }
      }

      function updateConnectionStatus(connected) {
        const badge = document.getElementById("connectionStatus");
        if (connected) {
          badge.textContent = "Connected";
          badge.variant = "success";
        } else {
          badge.textContent = "Disconnected";
          badge.variant = "danger";
        }
      }

      function connectWebSocket() {
        // Get the current hostname and port
        const host = window.location.hostname;

        ws = new WebSocket(`ws://${host}:${wsPort}`);

        ws.onopen = function () {
          updateConnectionStatus(true);
          notyf.success("Connected to logs");

          // Clear reconnect timer
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }
        };

        ws.onmessage = function (event) {
          try {
            const data = JSON.parse(event.data);

            if (data.type === "initial") {
              // Initial log batch
              allLogs = data.logs || [];
              displayLogs();
            } else if (data.type === "log") {
              // New single log entry
              const logEntry = {
                timestamp: data.timestamp,
                level: data.level,
                tag: data.tag,
                message: data.message,
              };
              allLogs.push(logEntry);

              // Only update display if not paused
              if (!isPaused) {
                displayLogs();
              }
            }
          } catch (e) {
            console.error("Error parsing WebSocket message:", e);
          }
        };

        ws.onerror = function (error) {
          console.error("WebSocket error:", error);
          notyf.error("WebSocket connection error");
        };

        ws.onclose = function () {
          console.log("WebSocket disconnected");
          updateConnectionStatus(false);
          notyf.error("Disconnected from log stream. Reconnecting...");

          // Attempt to reconnect after 3 seconds
          reconnectTimer = setTimeout(() => {
            connectWebSocket();
          }, 3000);
        };
      }

      // Connect on page load
      connectWebSocket();
    </script>
  </body>
</html>
