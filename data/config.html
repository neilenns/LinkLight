<!doctype html>
<html class="wa-dark wa-cloak" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>LinkLight - Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css"
    />
    <link rel="stylesheet" href="global.css" />
    <script
      src="https://kit.webawesome.com/2ef289f478d44f55.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script src="/notyf.js" defer></script>
    <style>
      .led-test-footer {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      body {
        width: 610px;
      }
    </style>
  </head>
  <body>
    <h1>LinkLight - Configuration</h1>

    <form id="configForm" onsubmit="event.preventDefault()">
      <wa-card>
        <h3 slot="header">Settings</h3>
        <div class="label-on-left">
          <wa-input
            label="Hostname"
            name="hostname"
            placeholder="LinkLight"
            hint="Used for mDNS discovery"
          ></wa-input>
          <wa-input
            label="API key"
            name="apiKey"
            placeholder="Enter OneBusAway API key"
            hint="Request an API key from SoundTransit and include it here"
          ></wa-input>
          <wa-select
            label="Timezone"
            name="timezone"
            hint="Your local timezone"
          >
            <wa-option value="PST8PDT,M3.2.0,M11.1.0"
              >Pacific Time (with DST)</wa-option
            >
            <wa-option value="PST8">Pacific Standard Time (no DST)</wa-option>
            <wa-option value="MST7MDT,M3.2.0,M11.1.0"
              >Mountain Time (with DST)</wa-option
            >
            <wa-option value="MST7">Mountain Standard Time (no DST)</wa-option>
            <wa-option value="CST6CDT,M3.2.0,M11.1.0"
              >Central Time (with DST)</wa-option
            >
            <wa-option value="CST6">Central Standard Time (no DST)</wa-option>
            <wa-option value="EST5EDT,M3.2.0,M11.1.0"
              >Eastern Time (with DST)</wa-option
            >
            <wa-option value="EST5">Eastern Standard Time (no DST)</wa-option>
            <wa-option value="UTC0">UTC</wa-option>
          </wa-select>
          <wa-number-input
            label="Refresh interval (seconds)"
            name="updateInterval"
            placeholder="15"
            min="15"
            max="60"
            hint="How often to check for train updates"
          ></wa-number-input>
          <wa-number-input
            label="At-station threshold (seconds)"
            name="atStationThreshold"
            placeholder="10"
            min="0"
            max="60"
            hint="How many seconds away trains can be from a station and still be considered at the station"
          ></wa-number-input>
          <wa-color-picker
            name="line1Color"
            format="hex"
            label="1 Line"
            swatches="#28813f"
            hint="Color used for 1 Line trains"
          ></wa-color-picker>
          <wa-color-picker
            name="line2Color"
            format="hex"
            label="2 Line"
            swatches="#007cad"
            hint="Color used for 2 Line trains"
          ></wa-color-picker>
          <wa-color-picker
            name="sharedColor"
            format="hex"
            no-format-toggle
            label="Shared segment"
            swatches="#232300"
            hint="Used when trains from both lines are on the same track segment"
          ></wa-color-picker>
        </div>

        <wa-button
          type="button"
          variant="primary"
          slot="footer"
          onclick="saveConfig()"
          >Save configuration</wa-button
        >
      </wa-card>
    </form>

    <wa-card>
      <h3 slot="header">Test station LEDs</h3>
      <p>
        Select a station to highlight its LEDs. The northbound LED is shown in
        green <span class="led-square-green"></span>. The southbound LED is
        shown in blue <span class="led-square-blue"></span>. The LEDs for trains
        on the way to the station in each direction are shown in yellow
        <span class="led-square-yellow"></span>.
      </p>
      <wa-select id="testStationSelect" label="Select station">
        <wa-option value="">Choose a station...</wa-option>
      </wa-select>
      <div class="led-test-footer" slot="footer">
        <wa-button onclick="testStation()">Test station LEDs</wa-button>
      </div>
    </wa-card>

    <script>
      function saveConfig() {
        var params = new URLSearchParams(
          new FormData(document.getElementById("configForm")),
        );

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/config", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded",
        );

        xhr.onload = function () {
          if (xhr.status === 200) {
            notyf.success("Configuration saved");
          } else {
            notyf.error("Error saving configuration: " + xhr.statusText);
          }
        };

        xhr.onerror = function () {
          notyf.error("Network error occurred");
        };

        xhr.send(params.toString());
      }

      function testStation() {
        var stationSelect = document.getElementById("testStationSelect");

        if (!stationSelect || !stationSelect.value) {
          notyf.error("Please select a station");
          return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/test-station", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded",
        );

        xhr.onload = function () {
          if (xhr.status === 200) {
            notyf.success("LEDs are now lit for the selected station");
          } else {
            notyf.error(`Error testing station: ${xhr.statusText}`);
          }
        };

        xhr.onerror = function () {
          notyf.error("Network error occurred");
        };

        xhr.send(`stationName=${encodeURIComponent(stationSelect.value)}`);
      }

      function setFieldValue(selector, value) {
        var el = document.querySelector(selector);
        if (el) el.value = value;
      }

      fetch("/api/config")
        .then(function (r) {
          return r.json();
        })
        .then(function (data) {
          setFieldValue('wa-input[name="hostname"]', data.hostname);
          setFieldValue('wa-input[name="apiKey"]', data.apiKey);
          setFieldValue('wa-select[name="timezone"]', data.timezone);
          setFieldValue(
            'wa-number-input[name="updateInterval"]',
            data.updateInterval,
          );
          setFieldValue(
            'wa-number-input[name="atStationThreshold"]',
            data.atStationThreshold,
          );
          setFieldValue('wa-color-picker[name="line1Color"]', data.line1Color);
          setFieldValue('wa-color-picker[name="line2Color"]', data.line2Color);
          setFieldValue('wa-color-picker[name="sharedColor"]', data.sharedColor);
        })
        .catch(function (e) {
          console.error("Failed to load config:", e);
        });

      fetch("/api/stations")
        .then(function (r) {
          return r.json();
        })
        .then(function (stations) {
          var select = document.getElementById("testStationSelect");
          stations.forEach(function (station) {
            var option = document.createElement("wa-option");
            option.value = station.id;
            option.textContent = station.name;
            select.appendChild(option);
          });
        })
        .catch(function (e) {
          console.error("Failed to load stations:", e);
        });
    </script>
  </body>
</html>
