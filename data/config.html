<!doctype html>
<html style="color-scheme: dark">
  <head>
    <title>LinkLight - Configuration</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://kit.webawesome.com/2ef289f478d44f55.js" crossorigin="anonymous"></script>
    <style>
      html {
        background-color: #1e1e1e;
      }

      body {
        color: #d4d4d4;
        padding: 20px;
        box-sizing: border-box;
        font-family: var(--wa-font-family-body);
        max-width: 600px;
      }

      h1 {
        color: #4ec9b0;
        margin: 0 0 20px 0;
      }

      .controls {
        margin-bottom: 20px;
      }

      .form-section {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #252526;
        border-radius: var(--wa-border-radius-m);
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .section-heading {
        color: #9cdcfe;
        font-size: var(--wa-font-size-m);
        font-weight: var(--wa-font-weight-semibold);
        margin: 0;
      }

      .color-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .color-row wa-color-picker {
        flex-shrink: 0;
      }

      .color-label {
        font-size: var(--wa-font-size-s);
        color: #d4d4d4;
      }
    </style>
  </head>
  <body>
    <h1>LinkLight - Configuration</h1>

    <div class="controls">
      <wa-button href="/" size="small">Home</wa-button>
    </div>

    <form method="POST" action="/config">
      <div class="form-section">
        <wa-input
          label="Hostname"
          name="hostname"
          value="{{hostname}}"
          placeholder="LinkLight"
        ></wa-input>
        <wa-input
          label="API key"
          name="apiKey"
          value="{{apiKey}}"
          placeholder="Enter OneBusAway API key"
        ></wa-input>
        <wa-select label="Timezone" name="timezone" value="{{timezone}}">
          <wa-option value="PST8PDT,M3.2.0,M11.1.0"
            >Pacific Time (with DST)</wa-option
          >
          <wa-option value="PST8">Pacific Standard Time (no DST)</wa-option>
          <wa-option value="MST7MDT,M3.2.0,M11.1.0"
            >Mountain Time (with DST)</wa-option
          >
          <wa-option value="MST7">Mountain Standard Time (no DST)</wa-option>
          <wa-option value="CST6CDT,M3.2.0,M11.1.0"
            >Central Time (with DST)</wa-option
          >
          <wa-option value="CST6">Central Standard Time (no DST)</wa-option>
          <wa-option value="EST5EDT,M3.2.0,M11.1.0"
            >Eastern Time (with DST)</wa-option
          >
          <wa-option value="EST5">Eastern Standard Time (no DST)</wa-option>
          <wa-option value="UTC0">UTC</wa-option>
        </wa-select>
        <wa-input
          label="Refresh interval (seconds)"
          name="updateInterval"
          type="number"
          value="{{updateInterval}}"
          min="15"
          max="60"
        ></wa-input>
      </div>

      <div class="form-section">
        <p class="section-heading">LED color settings</p>
        <div class="color-row">
          <wa-color-picker
            name="line1Color"
            value="{{line1Color}}"
            format="hex"
            without-format-toggle
            size="small"
            label="Line 1 color"
          ></wa-color-picker>
          <span class="color-label">Line 1 color</span>
        </div>
        <div class="color-row">
          <wa-color-picker
            name="line2Color"
            value="{{line2Color}}"
            format="hex"
            without-format-toggle
            size="small"
            label="Line 2 color"
          ></wa-color-picker>
          <span class="color-label">Line 2 color</span>
        </div>
        <div class="color-row">
          <wa-color-picker
            name="sharedColor"
            value="{{sharedColor}}"
            format="hex"
            without-format-toggle
            size="small"
            label="Overlap color (when both lines are at same spot)"
          ></wa-color-picker>
          <span class="color-label"
            >Overlap color (when both lines are at same spot)</span
          >
        </div>
      </div>

      <wa-button type="submit" variant="brand">Save configuration</wa-button>
    </form>

    <div class="form-section" style="margin-top: 20px">
      <p class="section-heading">Test station LEDs</p>
      <wa-select id="testStationSelect" label="Select station">
        <wa-option value="">Choose a station...</wa-option>
        {{#stations}}
        <wa-option value="{{id}}">{{name}}</wa-option>
        {{/stations}}
      </wa-select>
      <div>
        <wa-button onclick="testStation()">Test station LEDs</wa-button>
      </div>
      <wa-callout id="test-feedback" variant="success" hidden></wa-callout>
    </div>

    <script>
      function testStation() {
        var stationSelect = document.getElementById("testStationSelect");
        var feedbackAlert = document.getElementById("test-feedback");

        if (!stationSelect || !stationSelect.value) {
          feedbackAlert.variant = "danger";
          feedbackAlert.textContent = "Please select a station";
          feedbackAlert.removeAttribute("hidden");
          return;
        }

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "/test-station", true);
        xhr.setRequestHeader(
          "Content-Type",
          "application/x-www-form-urlencoded",
        );

        xhr.onload = function () {
          if (xhr.status === 200) {
            feedbackAlert.variant = "success";
            feedbackAlert.textContent =
              "Station LEDs are now lit! Northbound = Green, Southbound = Blue";
          } else {
            feedbackAlert.variant = "danger";
            feedbackAlert.textContent = `Error testing station: ${xhr.statusText}`;
          }
          feedbackAlert.removeAttribute("hidden");
          setTimeout(function () {
            feedbackAlert.setAttribute("hidden", "");
          }, 5000);
        };

        xhr.onerror = function () {
          feedbackAlert.variant = "danger";
          feedbackAlert.textContent = "Network error occurred";
          feedbackAlert.removeAttribute("hidden");
          setTimeout(function () {
            feedbackAlert.setAttribute("hidden", "");
          }, 5000);
        };

        xhr.send(`stationName=${encodeURIComponent(stationSelect.value)}`);
      }
    </script>
  </body>
</html>
